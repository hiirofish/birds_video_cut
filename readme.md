# 鳥の巣観測動画動き検出システム

このドキュメントでは、定点観測された鳥の巣の動画から動きがあった部分のみを検出し、クリップとして切り出すシステムについて解説します。

## 概要

このシステムは、ほぼ静止画である長時間の定点観測動画から、鳥などの動きがあった瞬間だけを効率的に検出し、該当部分の動画クリップと検出画像を生成します。天候の変化や明るさの変動にも対応できるよう最適化されています。

## 使用方法

### 基本的な使い方

```bash
python motion_detector.py 入力動画パス
```

これにより、デフォルト設定（最小面積=300、フレームスキップ=10）で動画を処理します。動きが検出されると、`output_detection`ディレクトリに検出画像、`output_video`ディレクトリに動画クリップが保存されます。

### コマンドライン引数

| 引数 | 説明 | デフォルト値 |
|------|------|------------|
| `video_path` | 入力動画のパス（必須） | - |
| `--detection_dir` | 検出結果の出力ディレクトリ | `output_detection` |
| `--video_dir` | 動画出力ディレクトリ | `output_video` |
| `--threshold` / `-t` | 動き検出の閾値 | `25` |
| `--min_area` / `-a` | 動きと判断する最小領域サイズ | `300` |
| `--frame_skip` / `-s` | フレームスキップ数 | `10` |
| `--start` | 分析開始時間 (H:M:S形式) | 動画の先頭 |
| `--end` | 分析終了時間 (H:M:S形式) | 動画の終わり |
| `--pre` | 動き検出前の秒数 | `10` |
| `--post` | 動き検出後の秒数 | `10` |
| `--merge` | イベントをマージする秒数の閾値 | `30` |
| `--debug` / `-d` | デバッグ情報を表示 | `False` |

### 使用例

#### 特定時間の範囲だけを処理

```bash
python motion_detector.py input_video.mp4 --start 1:30:00 --end 2:00:00
```

この例では、1時間30分から2時間の間の動画部分のみを処理します。

#### 検出感度を調整

```bash
# 小さな動きも検出（より敏感に）
python motion_detector.py input_video.mp4 --min_area 200

# 大きな動きのみ検出（誤検出を減らす）
python motion_detector.py input_video.mp4 --min_area 500
```

#### 処理速度と検出頻度のバランスを調整

```bash
# より高速に処理（精度は少し下がる）
python motion_detector.py input_video.mp4 --frame_skip 15

# より正確に検出（処理は遅くなる）
python motion_detector.py input_video.mp4 --frame_skip 5
```

#### 出力動画の前後時間を調整

```bash
# 動き検出の前後時間を変更（前30秒、後20秒）
python motion_detector.py input_video.mp4 --pre 30 --post 20
```

#### 詳細なログを確認

```bash
python motion_detector.py input_video.mp4 --debug
```

## 出力結果

### 検出画像（output_detection）

- **highlight画像**: 検出された動きの領域を緑色の枠で強調表示した画像
  - ファイル名形式: `motion_時_分_秒_highlight.jpg`
  - 例: `motion_01_45_23_highlight.jpg`

### 動画クリップ（output_video）

- 検出された動きの前後の時間を含む動画クリップ
  - ファイル名形式: `motion_開始時_分_秒_to_終了時_分_秒.mp4`
  - 例: `motion_01_45_13_to_01_45_43.mp4`

### その他の出力ファイル

- **detection_log.txt**: 検出プロセスの詳細ログ
- **detections.csv**: 検出された全イベントの情報（時間、面積、明るさなど）

## 動作アルゴリズム

このシステムは以下のような方法で動きを検出します：

### 1. 前処理

1. 入力動画から指定フレームレート（`frame_skip`で調整）でフレームを読み込み
2. 処理速度向上のためにフレームサイズを半分に縮小
3. グレースケール変換による処理の簡略化

### 2. 背景差分法による動き検出

1. **MOG2背景減算器**を使用して背景モデルを構築
   - `history=120`: 背景モデルの履歴長（直近120フレームを考慮）
   - `varThreshold=24`: 変化を検出する閾値（小さいほど敏感）
   - `detectShadows=False`: 影の検出を無効化（処理速度向上）

2. 二値化とノイズ除去
   - 背景差分の結果を二値化（白黒画像に変換）
   - モルフォロジー演算（侵食と膨張）でノイズを除去

3. 輪郭検出と面積計算
   - 二値化画像から輪郭を検出
   - 輪郭の面積（ピクセル数）を計算

### 3. 照明条件に応じた適応型検出

- **暗い環境（輝度 < 15）**: 動きなしと判断（夜間の誤検出防止）
- **薄暗い環境（輝度 15〜50）**: 感度を向上（閾値を0.7倍に下げる）
- **通常環境（輝度 > 50）**: 通常の閾値を適用

### 4. イベント管理

1. 動きが検出されるとイベント開始
2. 前後の指定時間（`pre`秒前、`post`秒後）を含むフレームを記録
3. 近接するイベント（`merge`秒以内）は自動的に結合

### 5. 出力生成

1. ハイライト画像: 検出された動き領域を緑色の枠で強調表示
2. 動画クリップ: イベント前後を含む区間を切り出し、元の音声を保持

## 内部パラメータの調整

### 検出感度の微調整

アルゴリズムの核心は「何を動きとみなすか」の判断にあります。主に以下のパラメータで調整できます：

- **最小面積（min_area）**: 動きと判断する最小のピクセル領域サイズ
  - 値を小さくすると小さな動きも検出（敏感に）
  - 値を大きくすると大きな動きのみ検出（誤検出減少）

- **変化閾値（threshold）**: 背景との差異をどの程度まで変化とみなすか
  - 値を小さくするとわずかな変化も検出
  - 値を大きくすると明確な変化のみ検出

### 時間帯に応じた自動調整

このシステムは、時間帯や照明条件に応じて自動的に感度を調整します：

1. **夜間（暗い環境）**: 検出を無効化
   - 夜間の微細なノイズや照明変化による誤検出を防止

2. **夕方（薄暗い環境）**: 感度を向上
   - 通常よりも閾値を30%下げて、薄暗い中での動きも検出

3. **日中（明るい環境）**: 通常感度で検出

### 処理速度と正確性のバランス

- **フレームスキップ（frame_skip）**: 処理するフレームの間隔
  - 値を大きくすると処理速度向上（ただし短い動きを見逃す可能性）
  - 値を小さくすると検出精度向上（ただし処理時間が増加）

## 技術的な詳細

### 使用ライブラリ

- **OpenCV**: 画像処理と動き検出
- **NumPy**: 数値計算と配列操作
- **FFmpeg**: 動画の切り出しと音声の抽出

### パフォーマンス考慮事項

- 長時間の動画を一度に処理する場合はメモリ使用量に注意
- GPUがある環境では、CUDA対応のOpenCVを使用することで処理を高速化可能
- 解像度の高い動画は処理時間が増加するため、必要に応じて入力解像度を下げることも検討

## トラブルシューティング

### 検出精度の問題

- **動きが検出されない場合**: `min_area`を小さくするか、`threshold`を下げる
- **誤検出が多い場合**: `min_area`を大きくするか、`threshold`を上げる
- **夕方/夜間の検出問題**: 明るさ条件のしきい値（15〜50）を調整

### 処理速度の問題

- **処理が遅い場合**: `frame_skip`を大きくする（例: 10→20）
- **メモリ不足エラー**: 動画を時間範囲で分割して処理

## 応用例

このシステムは以下のような用途に応用できます：

1. **鳥の巣観察**: 長時間の観察動画から鳥の出入りのみを抽出
2. **野生動物モニタリング**: 定点カメラからの動物の動きを検出
3. **セキュリティ監視**: 特定エリアでの動きを効率的に記録
4. **天体観測**: 長時間露光中の特定の天体現象を検出

## まとめ

このシステムは、適応型の背景差分法とイベント管理機能を組み合わせることで、長時間の定点観測動画から効率的に動きを検出し、関連する動画クリップを生成します。照明条件の変化に対応する適応型検出機能により、日中から夕方、夜間まで幅広い環境で利用できます。