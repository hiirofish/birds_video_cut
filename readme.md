# 🦅 鳥の巣ライブカメラ用・動き検出＆動画クリッピングシステム

このドキュメントでは、定点観測された鳥の巣の動画から、鳥などの動きがあった部分のみを検出し、ハイライト動画として自動的に切り出すシステムの技術的な詳細と使用方法について解説します。

## ✨ 主な機能

* **高効率な動き検出**: 長時間動画から動きのあるシーンのみをミリ秒単位で正確に特定します。
* **インテリジェントなクリッピング**: 検出されたシーンの前後を含めた動画クリップを、音声付きで自動生成します。
* **適応型感度調整**: 映像の明るさをリアルタイムで分析し、日中・夕方・夜間で検出感度を自動で最適化。天候の変化による誤検出を抑制します。
* **🆕 複数ファイル一括処理**: `input`フォルダ内の全動画を自動検出し、連続して処理できます。
* **🆕 自動ディレクトリ命名**: 出力フォルダ名にファイル名を自動追加（例：`output_video_0524`）し、ファイル管理を簡単にします。
* **柔軟なパラメータ**: コマンドラインから検出感度や処理速度を細かくチューニング可能です。
* **詳細なレポート**: 検出時の静止画や、全イベントを記録したCSVログを出力し、後の分析を容易にします。

## 💻 使い方

### 必要なもの

* Python 3.x
* OpenCV, NumPy ライブラリ
    ```bash
    pip install opencv-python numpy
    ```
* **FFmpeg**: 動画の切り出しと音声処理のために、システムにインストールされ、パスが通っている必要があります。

### 🆕 複数ファイル処理（推奨）

**inputフォルダを作成し、動画ファイルを配置:**
```
input/
├── 0524.mp4
├── 0525.mp4
└── bird_nest_video.mp4
```

**全ファイルを一括処理:**
```bash
# inputフォルダ内の全動画を処理
python motion_detector.py

# 特定のディレクトリ内の全動画を処理
python motion_detector.py /path/to/videos

# パラメータを指定して複数ファイル処理
python motion_detector.py input --threshold 40 --min_area 500
```

**出力結果:**
```
output_detection_0524/    # 0524.mp4の検出結果
output_video_0524/        # 0524.mp4の動画クリップ
output_detection_0525/    # 0525.mp4の検出結果
output_video_0525/        # 0525.mp4の動画クリップ
output_detection_bird_nest_video/
output_video_bird_nest_video/
```

### 単一ファイル処理（従来の方法）

```bash
# 単一ファイルを処理
python motion_detector.py 0524.mp4 --single

# または、ファイルパスを直接指定
python motion_detector.py /path/to/0524.mp4
```

### コマンドライン引数

| 引数 | 説明 | デフォルト値 |
|------|------|-------------|
| `input_path` | 入力動画のパスまたはinputディレクトリ | `input` |
| `--detection_dir` | 検出画像の出力ディレクトリベース名 | `output_detection` |
| `--video_dir` | 動画クリップの出力ディレクトリベース名 | `output_video` |
| `--threshold`, `-t` | 動き検出の二値化閾値（感度） | `50` |
| `--min_area`, `-a` | 動きと判断する最小領域サイズ（ピクセル数） | `300` |
| `--frame_skip`, `-s` | 処理をスキップするフレーム数（速度と精度のトレードオフ） | `20` |
| `--start` | 分析を開始する時間 (`H:M:S`形式) | 動画の先頭 |
| `--end` | 分析を終了する時間 (`H:M:S`形式) | 動画の終わり |
| `--pre` | 動き検出時点から遡ってクリップに含める秒数 | `3` |
| `--post` | 動き検出時点から後方にクリップに含める秒数 | `3` |
| `--merge` | 近接イベントを一つにまとめる時間閾値（秒） | `10` |
| `--skip_initial` | 最初にスキップする秒数（誤検出防止） | `60` |
| `--single` | 単一ファイル処理モード（従来の動作） | `False` |
| `--debug`, `-d` | 詳細なデバッグ情報をコンソールに表示 | `False` |

## 💡 使用例

**複数ファイルで特定の時間範囲を処理:**
```bash
python motion_detector.py input --start 1:30:00 --end 2:00:00
```

**検出感度を調整して複数ファイル処理:**
```bash
python motion_detector.py input -a 200 -t 30
```

**単一ファイルで処理速度を優先:**
```bash
python motion_detector.py video.mp4 --single -s 15
```

**カスタム出力ディレクトリ名で複数ファイル処理:**
```bash
python motion_detector.py input --detection_dir my_detection --video_dir my_video
# 出力: my_detection_0524, my_video_0524 など
```

## 🎬 出力について

### 🆕 自動ディレクトリ命名

各動画ファイルごとに、ファイル名を末尾に付けた専用ディレクトリが作成されます：

**入力:** `0524.mp4`
- **検出結果:** `output_detection_0524/`
- **動画クリップ:** `output_video_0524/`

### 検出画像

動きを検出した瞬間のフレームが画像として保存されます。緑色の矩形は検出された輪郭を示します。

* **ファイル名**: `motion_時_分_秒_highlight.jpg`
* **例**: `motion_01_45_23_highlight.jpg`

### 動画クリップ

検出されたイベントの前後（`--pre`, `--post`で指定）を含む動画クリップが、元の音声を保持したまま生成されます。

* **ファイル名**: `motion_開始時_分_秒_to_終了時_分_秒.mp4`
* **例**: `motion_01_45_13_to_01_45_43.mp4`

### ログファイル

* `detection_log.txt`: 検出プロセスの詳細な動作ログ。
* `detections.csv`: 全ての検出イベント（時間、面積、輝度など）を記録したCSVファイル。

## 🆕 複数ファイル処理の特徴

### 進捗表示
処理中は詳細な進捗が表示されます：

```
==================================================
処理中 (1/3): 0524.mp4
==================================================
[2025-07-08 14:30:15] 処理開始: input/0524.mp4
進捗: 25% (125000/500000), 速度: 45.2fps, 残り: 182.3秒, 検出: 5件
...
✓ 処理完了: 0524.mp4
```

### 対応動画形式
以下の形式を自動検出します：
- MP4, AVI, MOV, MKV, WMV, FLV, WebM
- 大文字小文字の両方に対応

### エラーハンドリング
- 個別のファイルでエラーが発生しても、他のファイルの処理は続行
- 全体の処理結果サマリーを表示

```
==================================================
全体の処理結果
==================================================
処理済み動画: 3/3
総処理時間: 450.2秒
平均処理時間: 150.1秒/動画
```

## 🧠 動作の仕組み (アルゴリズム)

本システムは、以下のステップで動作します。

### 1. 前処理

パフォーマンス向上のため、動画から読み込んだ各フレームに対して以下の処理を行います。

1. **フレームサイズ縮小**: 解像度を半分にし、計算量を削減します。
2. **グレースケール変換**: 色情報を削除し、輝度情報のみで処理を高速化します。
3. **ガウシアンブラー**: 微小なノイズを平滑化し、誤検出を抑制します。

### 2. 動き検出（コア技術）

OpenCVの`MOG2 (Mixture of Gaussians)`背景差分法をコア技術として採用しています。

* 過去のフレームから統計的な「背景モデル」をリアルタイムに構築します。
* 現在のフレームと背景モデルを比較し、「ありえない変化」を前景（＝動き）として抽出します。
* 影の検出は無効化 (`detectShadows=False`) し、鳥の影などを動きとして誤検出するのを防ぎます。

### 3. 適応型スレッショルド（賢い感度調整）

1フレームごとに平均輝度を計算し、照明条件に応じて検出感度を動的に調整します。

* **夜間 (輝度 < 15)**: 検出を一時停止。赤外線カメラのノイズ等による誤検出を完全に防ぎます。
* **夕暮れ/夜明け (輝度 15〜50)**: 検出閾値を自動的に引き下げ（感度UP）、薄暗い環境での動きを捉えやすくします。
* **日中 (輝度 > 50)**: 通常の感度で動作します。

### 4. イベント管理と動画生成

* `--min_area` を超える動きが検出されると、「イベント」として記録を開始します。
* `--pre` と `--post` の設定に基づき、イベントの開始時刻と終了時刻を決定します。
* `--merge` で指定した秒数以内に次のイベントが発生した場合、それらを一つの長いイベントとして自動的に結合します。
* 最終的に確定したイベント区間を、**FFmpeg**を使って元の動画から正確に切り出し、音声もそのまま含んだクリップを生成します。

## 🛠️ パラメータチューニングガイド

最適な結果を得るための調整のヒントです。

| 目的 | 推奨パラメータ | 説明 |
|------|----------------|------|
| **小さな動きも逃したくない** | `--min_area` を小さくする (例: `200`) | 葉の揺れなども検出する可能性があるので、`--threshold`も調整が必要。 |
| **誤検出を徹底的に減らしたい** | `--min_area` を大きくする (例: `500`) | 鳥のような大きなオブジェクトの動きのみをターゲットにする。 |
| **処理をとにかく速くしたい** | `--frame_skip` を大きくする (例: `30`) | 処理速度は上がりますが、素早い動き（一瞬でフレームを横切るなど）を見逃す可能性があります。 |
| **検出の瞬間をより正確にしたい** | `--frame_skip` を小さくする (例: `10`) | 処理時間は増えますが、イベントの開始・終了タイミングがより正確になります。 |
| **クリップを長めにしたい** | `--pre` と `--post` を大きくする (例: `15`) | 動きの文脈が分かりやすくなります。 |
| **🆕 複数ファイル一括処理** | 引数なしで実行 | `input/`フォルダ内の全動画を自動処理。 |

## 🚀 効率的なワークフロー

### 推奨手順

1. **動画ファイルの準備**
   ```bash
   mkdir input
   # 処理したい動画ファイルをinputフォルダに配置
   ```

2. **一括処理の実行**
   ```bash
   # 標準設定で全ファイルを処理
   python motion_detector.py
   ```

3. **結果の確認**
   ```bash
   # 各ファイルごとに専用フォルダが作成される
   ls output_*
   ```

4. **パラメータ調整**（必要に応じて）
   ```bash
   # 感度調整して再処理
   python motion_detector.py input --min_area 400 --threshold 40
   ```

## ❓ トラブルシューティング

* **動きが全く検出されない**: `--min_area` や `--threshold` の値を下げてみてください。また、`--debug`オプションを付けて実行し、コンソールに表示される「面積」や「輝度」の値を確認してください。
* **誤検出が多すぎる**: 木の葉の揺れなどを拾っている可能性があります。`--min_area`の値を大きくしてみてください。
* **処理が遅すぎる**: 動画の解像度が高い可能性があります。`--frame_skip`を大きくするか、元動画を低い解像度に変換してから処理することも有効です。
* **🆕 inputフォルダが見つからない**: `mkdir input`でフォルダを作成し、動画ファイルを配置してください。
* **🆕 一部のファイルだけ処理したい**: 特定のファイルを別フォルダに移動するか、`--single`オプションで個別処理してください。

## 📝 更新履歴

### v2.0 (新機能)
- ✅ 複数ファイル一括処理機能を追加
- ✅ 自動ディレクトリ命名機能を追加
- ✅ 進捗表示とエラーハンドリングを改善
- ✅ 対応動画形式を拡張
- ✅ 処理結果サマリー機能を追加